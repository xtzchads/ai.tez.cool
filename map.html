<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="TezMoon Simulator">
  <title>Chad Map</title>
  <script src="js/highcharts.js"></script>
  <script src="js/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/boost.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/main.css">
  <script src="js/background.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    .container {
      height: 100%;
      padding: 0;
    }

    #chadmap {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="particle-canvas"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <figure class="highcharts-figure">
          <div id="chadmap"></div>
        </figure>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function fetchData(url) {
        return fetch(url).then(response => response.json());
      }

      function processAccountData(data) {
        return data.filter(account => (account.stakedBalance || 0) >= 1000000000).map(account => {
          const name = account.alias ? account.alias : account.address;
          const stakedBalance = account.stakedBalance || 0;
          return {
            name: name,
            value: stakedBalance / 1e6,
            stakedBalance: stakedBalance,
            display: name + ': ' + (stakedBalance / 1e6).toLocaleString() + ' XTZ'
          };
        });
      }

      function initChart(processedData) {
        Highcharts.chart('chadmap', {
          chart: {
            type: 'packedbubble',
            backgroundColor: 'rgba(0,0,0,0)',
            boost: {
              useGPUTranslations: true,
              usePreAllocated: true
            }
          },
          title: {
            text: 'Tezos Chad Map',
            style: {
              color: '#ffffff'
            }
          },
          tooltip: {
            useHTML: true,
            pointFormat: '<b>{point.display}</b>'
          },
          plotOptions: {
            packedbubble: {
              boostThreshold: 1,
              minSize: '1%',
              maxSize: '100%',
              zMin: 0,
              zMax: Math.max(...processedData.map(d => d.value)),
              colorByPoint: true,
              layoutAlgorithm: {
                gravitationalConstant: 0.005,
                splitSeries: false,
                seriesInteraction: true,
                dragBetweenSeries: true,
                parentNodeLimit: true
              },
              dataLabels: {
                enabled: false
              },
              states: {
                hover: {
                  enabled: false,
                  halo: {
                    size: 0
                  }
                }
              },
            }
          },
          colorAxis: {
            min: 0,
            max: Math.max(...processedData.map(d => d.value)),
            stops: [
              [0, '#00f2f2'],
              [0.5, '#00d0d0'],
              [1, '#007777']
            ],
            minColor: '#00f2f2',
            maxColor: '#007777'
          },
          series: [{
            name: 'Chad Energy',
            data: processedData
          }],
          legend: {
            enabled: false
          },
          responsive: {
            rules: [{
              condition: {},
              chartOptions: {
                plotOptions: {
                  packedbubble: {
                    minSize: '30%',
                    maxSize: '200%'
                  }
                }
              }
            }]
          },
          credits: {
            enabled: false
          }
        });
      }

      Promise.all([
        fetchData('https://api.tzkt.io/v1/accounts?stakedPseudotokens.gt=0&limit=10000'),
        fetchData('https://api.tzkt.io/v1/delegates?active=true&limit=10000')
      ]).then(results => {
        const accountData = processAccountData(results[0]);
        const delegateData = processAccountData(results[1]);
        const combinedData = [...accountData, ...delegateData];

        initChart(combinedData);
      }).catch(error => console.error('Error fetching data:', error));
    });
  </script>
</body>

</html>
